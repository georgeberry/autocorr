---
title: "make plots"
output: html_document
---

Plots to make here
- A table with the error/bias numbers for all runs, should also have a ranking
- Main sims plot illustrating main point (DONE)
- All sims plot (except sampling) for appendix (DONE)
- Sampling sims plot (DONE)
- Performance plot for main text (DONE)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xtable)
library(tidyverse)
library(cowplot)
palette = c(
  "#E69F00",
  "#56B4E9",
  "#009E73",
  "#D55E00",
  "#0072B2",
  "#CC79A7",
  "#999999",
  "#F0E442"
)

palette3 = c(
    "#E69F00",
    "#009E73",
    "#CC79A7"
)
```


### main plots

1. Load and make data
2. Clear plots for main section of paper
3. Table for appendix

```{r, data}
df_sim = read_csv(
  '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_main.csv'
)
df_perf = read_csv(
  '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_perf.csv'
)
```

```{r, make_data}
df = df_sim %>%
  pivot_longer(
    cols=Y_no_model:Y_hat_egoalter_full,
    names_to='model',
    values_to='model_val'
  ) %>%
  mutate(
    mae=abs(model_val - Y_true) / Y_true,
    bias=(model_val - Y_true) / Y_true,
    model=case_when(
      model == 'Y_no_model' ~ 'No model',
      model == "Y_hat_node_nonetwork" ~ "Node\n(no network)",
      model == "Y_hat_node_basic" ~ "Node",
      model == "Y_hat_node_full" ~ "Node\n(more controls)",
      model == "Y_hat_edge_nonetwork" ~ "Edge\n(no network)",
      model == "Y_hat_edge_basic" ~ "Edge",
      model == "Y_hat_edge_full" ~ "Edge\n(more controls)",
      model == "Y_hat_egoalter_basic" ~ "Ego-alter",
      model == "Y_hat_egoalter_full" ~ "Ego-alter\n(more controls)",
    ),
    model=factor(
      model,
      levels=rev(c(
        'No model',
        "Edge",
        "Edge\n(no network)",
        "Edge\n(more controls)",
        "Node",
        "Node\n(no network)",
        "Node\n(more controls)",
        "Ego-alter",
        "Ego-alter\n(more controls)",
        "Ego-alter\n(alternate)"
      ))
    ),
    Sampling=case_when(
      sampling == 'deg' ~ 'Prop. to\ndegree',
      sampling == 'edge' ~ 'Edge',
      sampling == 'node' ~ 'Node',
    )
  )

df_p = df_perf %>%
  pivot_longer(
    cols=auc:accuracy,
    names_to='metric',
    values_to='val'
  ) %>%
  mutate(
    model=case_when(
      model == "node_nonetwork" ~ "Node\n(no network)",
      model == "node_basic" ~ "Node",
      model == "node_full" ~ "Node\n(more controls)",
      model == "egoalter_basic" ~ "Ego-alter",
      model == "egoalter_full" ~ "Ego-alter\n(more controls)",
    ),
    sampling=case_when(
      sampling == 'deg' ~ 'Prop. to degree sampling',
      sampling == 'edge' ~ 'Edge sampling',
      sampling == 'node' ~ 'Node sampling',
    )
  )  %>%
  group_by(model, sampling, metric) %>%
  summarize(
    std=sd(val) / sqrt(n()),
    val=mean(val)
  ) %>%
  inner_join(
    df %>%
      group_by(sampling, model) %>%
      summarize(mae=mean(mae), bias=mean(bias)),
    by=c('model', 'sampling')
  )
```

```{r}
p1 = df %>%
  filter(!(model %in% c(
    'No model',
    "Edge\n(more controls)",
    "Node\n(more controls)"
  ))) %>% 
  group_by(model, Sampling) %>%
  summarize(std=sd(mae) / sqrt(n()), mae=mean(mae)) %>%
  mutate(lcl = mae - 1.96 * std, ucl = mae + 1.96 * std) %>%
  ggplot(aes(x=model, y=mae)) +
  geom_point(aes(color=Sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=Sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  labs(x='Model', y='Absolute error (percent)', title='Absolute error') +
  theme_cowplot() +
  coord_flip()

p2 = df %>%
  filter(!(model %in% c(
    'No model',
    "Edge\n(more controls)",
    "Node\n(more controls)"
  ))) %>% 
  group_by(model, Sampling) %>%
  summarize(std=sd(bias) / sqrt(n()), Bias=mean(bias)) %>%
  mutate(lcl = Bias - 1.96 * std, ucl = Bias + 1.96 * std) %>%
  ggplot(aes(x=model, y=Bias)) +
  geom_point(aes(color=Sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=Sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  theme_cowplot() +
  labs(x='Model', y='Bias (percent)', title='Bias') +
  theme_cowplot() +
  coord_flip()

plot_grid(p1, p2, labels = c('A','B'))
```
```{r}

```
```{r}

```




Every model


```{r}
df %>%
  filter(model != 'No model') %>%
  group_by(model, Sampling) %>%
  summarize(std=sd(mae) / sqrt(n()), mae=mean(mae)) %>%
  mutate(lcl = mae - 1.96 * std, ucl = mae + 1.96 * std) %>%
  ggplot(aes(x=model, y=mae)) +
  geom_point(aes(color=Sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=Sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  labs(x='Model', y='Absolute error (percent)', title='Homophily absolute error') +
  theme_cowplot() +
  coord_flip() #+
  # scale_color_brewer(palette="Set1")
```

```{r}
df %>%
  filter(model != 'No model') %>%
  group_by(model, Sampling) %>%
  summarize(std=sd(bias) / sqrt(n()), Bias=mean(bias)) %>%
  mutate(lcl = Bias - 1.96 * std, ucl = Bias + 1.96 * std) %>%
  ggplot(aes(x=model, y=Bias)) +
  geom_point(aes(color=Sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=Sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  theme_cowplot() +
  labs(x='Model', y='Bias (percent)', title='Homophily bias') +
  theme_cowplot() +
  coord_flip()
```



```{r}
df %>%
  filter(!(model %in% c(
    'No model'
  ))) %>% 
  group_by(model, sampling) %>%
  summarize(std=sd(mae) / sqrt(n()), mae=mean(mae)) %>%
  mutate(lcl = mae - 1.96 * std, ucl = mae + 1.96 * std) %>%
  ggplot(aes(x=model, y=mae)) +
  geom_point(aes(color=sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```





```{r}
df %>%
  filter(!(model %in% c(
    'No model'
  ))) %>% 
  group_by(model, sampling) %>%
  summarize(std=sd(bias) / sqrt(n()), bias=mean(bias)) %>%
  mutate(lcl = bias - 1.96 * std, ucl = bias + 1.96 * std) %>%
  ggplot(aes(x=model, y=bias)) +
  geom_point(aes(color=sampling), position=position_dodge(width=0.3)) +
  geom_errorbar(aes(ymin=lcl, ymax=ucl, color=sampling), width=0.2, position=position_dodge(width=0.3)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```

```{r}
df %>%
  filter(!(model %in% c(
    'No model',
    "Edge\n(no network)",
    "Edge\n(more controls)",
    "Node\n(more controls)",
    "Ego-alter\n(more controls)"
  ))) %>%
  ggplot(aes(x=model, y=bias)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_boxplot() +
  facet_wrap(~sampling) + 
  theme_cowplot() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
```





## Main sims plot (main text)

```{r}
p1 = df_bias %>%
  filter(sim == 'Main', model != "Ego-alter\n(downsampled)") %>%
  rename(
    Sampling=level
  ) %>%
  mutate(
    Sampling=case_when(
      Sampling == 'edge' ~ 'Edge',
      Sampling == 'node' ~ 'Node'
    )
  ) %>%
  ggplot(aes(x=model, y=val, fill=Sampling)) +
  geom_hline(yintercept=0, linetype='dotdash', alpha=0.5) +
  geom_boxplot() +
  labs(x='Model', y='Bias (percent)', title='Homophily bias') +
  guides(fill=FALSE) +
  theme_cowplot() +
  theme(
    axis.text=element_text(size=10)
  )

p2 = df_mae %>%
  filter(sim == 'Main', model != "Ego-alter\n(downsampled)") %>%
  rename(
    Sampling=level
  ) %>%
  mutate(
    Sampling=case_when(
      Sampling == 'edge' ~ 'Edge',
      Sampling == 'node' ~ 'Node'
    )
  ) %>%
  ggplot(aes(x=model, y=val, fill=Sampling)) +
  geom_hline(yintercept=0, linetype='dotdash', alpha=0.5) +
  geom_boxplot() +
  labs(x='Model', y='MAE (percent)', title='Homophily mean absolute error') +
  theme_cowplot() +
  theme(
    legend.position = c(0.7, 0.85),
    axis.text=element_text(size=10),
  )
```

```{r}
p_main = plot_grid(p1, p2, labels = c('A','B'))
```


## Perf plot

```{r, refine_perf_data}

```

```{r}
df_perf_plot %>%
  ggplot(aes(x=val, y=mae, color=model, shape=sampling)) +
  geom_point() +
  facet_wrap(~metric)
```


```{r,  fig.width=4, fig.height=1}
p3 = df_perf %>%
  group_by(model, metric, sampling) %>%
  summarize(
    std=sd(val) / sqrt(n()),
    val=mean(val)
  ) %>%
  inner_join(
    df_mae %>%
      filter(sim=='Main') %>%
      group_by(model, level) %>%
      summarize(
        std=sd(val) / sqrt(n()),
        val=mean(val)
      ),
    by=c('model', 'level'),
    suffix = c('_perf', '_mae')
  ) %>%
  rename(
    Model=model,
    Sampling=level
  ) %>%
  mutate(
    Sampling=case_when(
      Sampling == 'edge' ~ 'Edge',
      Sampling == 'node' ~ 'Node'
    )
  ) %>%
  ggplot(aes(x=val_perf, y=val_mae, color=Model, shape=Sampling)) +
  geom_hline(yintercept=0, linetype='dotdash') +
  geom_point(size=2, stroke=2) +
  facet_wrap(~metric, nrow=1) +
  lims(y = c(-0.03, 0.2)) +
  labs(x = element_blank(), y='MAE') +
  theme_cowplot() +
  theme(
    axis.text=element_text(size=8),
    legend.text=element_text(size=10),
    legend.position = 'bottom'
  ) +
  scale_shape_manual(values=c(1,3))
```

```{r}
p4 = df_perf %>%
  filter(model!='Ego-alter\n(downsampled)') %>%
  group_by(model, metric, level) %>%
  summarize(
    std=sd(val) / sqrt(n()),
    val=mean(val)
  ) %>%
  inner_join(
    df_bias %>%
      filter(sim=='Main') %>%
      group_by(model, level) %>%
      summarize(
        std=sd(val) / sqrt(n()),
        val=mean(val)
      ),
    by=c('model', 'level'),
    suffix = c('_perf', '_bias')
  ) %>%
  rename(
    Model=model,
    Sampling=level
  ) %>%
  mutate(
    Sampling=case_when(
      Sampling == 'edge' ~ 'Edge',
      Sampling == 'node' ~ 'Node'
    )
  ) %>%
  ggplot(aes(x=val_perf, y=val_bias, color=Model, shape=Sampling)) +
  geom_hline(yintercept=0, linetype='dotdash') +
  geom_point(size=4, stroke=1.5) +
  facet_wrap(~metric, nrow=1, strip.position ='bottom') +
  lims(y = c(-0.2, 0.05), x=c(0.71, 0.87)) +
  labs(x = element_blank(), y='Homophily bias\n(percent)', title='Homophily bias compared to node-level performance') +
  theme_cowplot() +
  panel_border() +
  theme(
    axis.text=element_text(size=8),
    # strip.text.x = element_blank(),
  ) +
  scale_color_manual(values=palette) +
  scale_shape_manual(values=c(1,3))
  # guides(shape=FALSE, color=FALSE)
```


 


## All sims(appendix)


```{r}
p5 = df_bias %>%
  filter(model != "Ego-alter\n(downsampled)") %>%
  mutate(
    val=ifelse(abs(val) > 0.4, sign(val) * 0.4, val)
  ) %>%
  group_by(sim, level, model) %>%
  summarize(
    std=sd(val),
    val=mean(val)
  ) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level=='edge' ~ 'Edge sample',
      level=='node' ~ 'Node sample'
    )
  ) %>%
  rename(
    Simulation=sim
  ) %>%
  ggplot(aes(x=model, y=val, color=Simulation)) +
  geom_hline(yintercept=0, alpha=0.5, linetype='dotdash') +
  #geom_boxplot() +
  geom_point(position=position_dodge(width=0.6)) +
  geom_errorbar(
    aes(ymin=val - std, ymax = val + std),
    position=position_dodge(width=0.6),
    width=0.0
  ) +
  guides(colour = guide_legend(reverse=T)) +
  scale_color_manual(values=palette) +
  labs(
    x='Model',
    y='Bias (percent)',
    title='Comparison of all models across five simulations') + 
  theme_cowplot() +
  theme(
    legend.position="top",
    axis.text=element_text(size=10)
  ) +
  coord_flip() +
  panel_border() +
  facet_wrap(~level)

p6 = df_mae %>%
  filter(model != "Ego-alter\n(downsampled)") %>%
  mutate(
    val=ifelse(abs(val) > 0.4, sign(val) * 0.4, val)
  ) %>%
  #group_by(sim, level, model) %>%
  #summarize(
  #  std=sd(val),
  #  val=mean(val)
  #) %>%
  #ungroup() %>%
  mutate(
    level=case_when(
      level=='edge' ~ 'Edge sample',
      level=='node' ~ 'Node sample'
    )
  ) %>%
  rename(
    Simulation=sim
  ) %>%
  ggplot(aes(x=model, y=val, color=Simulation)) +
  geom_hline(yintercept=0, alpha=0.5, linetype='dotdash') +
  #geom_violin() +
  geom_boxplot() +
  #geom_point(position=position_dodge(width=0.6)) +
  #geom_errorbar(
  #  aes(ymin=val - std, ymax = val + std),
  #  position=position_dodge(width=0.6),
  #  width=0.0
  #) +
  guides(colour = guide_legend(reverse=T)) +
  scale_color_manual(values=palette) +
  labs(x='Model', y='Mean absolute error (percent)') + 
  theme_cowplot() +
  coord_flip() +
  theme(
    legend.position = 'none',
    axis.text=element_text(size=10)
  ) +
  panel_border() +
  facet_wrap(~level)
```



```{r}
plot_grid(p5, p6, ncol=1, rel_heights=c(1.15,1), labels=c('A', 'B'))
```

#### MAKE A TABLE FOR THE CURIOUS

sim/level on the y axis, model on the x axis

```{r}
df_table_mae = df_mae %>%
  group_by(sim, level, model) %>% 
  summarize(std=sd(val) / sqrt(n()), mu=mean(val)) %>%
  #pivot_longer(std:mu, names_to='metric', values_to='val') %>%
  #pivot_wider(names_from=model, values_from='val') %>%
  pivot_longer(mu, names_to='metric', values_to='val') %>%
  pivot_wider(id_cols=sim:level, names_from=model, values_from='val') %>%
  arrange(level, sim) %>%
  select(level, sim, everything()) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level == 'edge' ~ 'Edge',
      level == 'node' ~ 'Node'
    )
  ) %>%
  rename(
    Sim=sim,
    `\thead{Sampling level}`=level,
    `\thead{Node (no network)}`=`Node\n(no network)`,
    `\thead{Ego-alter (augmented)}`=`Ego-alter\n(augmented)`
  )

print(
  xtable(
    df_table_mae,
    digits=3,
    caption='Mean absolute error by simulation'
  ),
  include.rownames=FALSE
)
```



```{r}
df_table_bias = df_bias %>%
  group_by(sim, level, model) %>% 
  summarize(std=sd(val) / sqrt(n()), mu=mean(val)) %>%
  #pivot_longer(std:mu, names_to='metric', values_to='val') %>%
  #pivot_wider(names_from=model, values_from='val') %>%
  pivot_longer(mu, names_to='metric', values_to='val') %>%
  pivot_wider(id_cols=sim:level, names_from=model, values_from='val') %>%
  arrange(level, sim) %>%
  select(level, sim, everything()) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level == 'edge' ~ 'Edge',
      level == 'node' ~ 'Node'
    )
  ) %>%
  rename(
    Sim=sim,
    `\thead{Sampling level}`=level,
    `\thead{Node (no network)}`=`Node\n(no network)`,
    `\thead{Ego-alter (augmented)}`=`Ego-alter\n(augmented)`
  )

print(
  xtable(
    df_table_bias,
    digits=3,
    caption='Bias by simulation'
  ),
  include.rownames=FALSE
)
```