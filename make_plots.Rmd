---
title: "make plots"
output: html_document
---

Plots to make here
- A table with the error/bias numbers for all runs, should also have a ranking
- Main sims plot illustrating main point (DONE)
- All sims plot (except sampling) for appendix (DONE)
- Sampling sims plot (DONE)
- Performance plot for main text (DONE)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(xtable)
library(tidyverse)
library(cowplot)
palette = c(
  "#E69F00",
  "#56B4E9",
  "#009E73",
  "#D55E00",
  "#0072B2",
  "#CC79A7",
  "#999999",
  "#F0E442"
)

palette3 = c(
    "#E69F00",
    "#009E73",
    "#CC79A7"
)
```


### main plots

1. Load and make data
2. Clear plots for main section of paper
3. Table for appendix

```{r, data}
df_sim = read_csv(
  '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_main.csv'
)
df_perf = read_csv(
  '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_perf.csv'
)

df_all = bind_rows(
  read_csv(
    '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_main.csv'
  ) %>%
    mutate(
      kind='main',
      beta=0.7,
      gamma=0
    ),
  read_csv(
    '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_low_homophily.csv'
  ) %>%
    mutate(
      kind='low',
      beta=0.4,
      gamma=0
    ),
  read_csv(
    '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_no_homophily.csv'
  ) %>%
    mutate(
      kind='no',
      beta=0,
      gamma=0
    ),
  read_csv(
    '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_x_homophily.csv'
  ) %>%
    mutate(
      kind='x',
      beta=0,
      gamma=0.5
    ),
  read_csv(
    '/Users/georgeberry/Dropbox/project-autocorr/data/new_sims_high_homophily.csv'
  ) %>%
    mutate(
      kind='high',
      beta=1.2,
      gamma=0
    ),
)
```

```{r, make_data}
df = df_sim %>%
  pivot_longer(
    cols=Y_no_model:Y_hat_egoalter_full,
    names_to='model',
    values_to='model_val'
  ) %>%
  mutate(
    mae=abs(model_val - Y_true) / Y_true,
    bias=(model_val - Y_true) / Y_true,
    model=case_when(
      model == 'Y_no_model' ~ 'No model',
      model == "Y_hat_node_nonetwork" ~ "Node\n(no network)",
      model == "Y_hat_node_basic" ~ "Node",
      model == "Y_hat_node_full" ~ "Node\n(more controls)",
      model == "Y_hat_edge_nonetwork" ~ "Edge\n(no network)",
      model == "Y_hat_edge_basic" ~ "Edge",
      model == "Y_hat_edge_full" ~ "Edge\n(more controls)",
      model == "Y_hat_egoalter_basic" ~ "Ego-alter",
      model == "Y_hat_egoalter_full" ~ "Ego-alter\n(more controls)",
    ),
    model=factor(
      model,
      levels=rev(c(
        'No model',
        "Edge",
        "Edge\n(no network)",
        "Edge\n(more controls)",
        "Node",
        "Node\n(no network)",
        "Node\n(more controls)",
        "Ego-alter",
        "Ego-alter\n(more controls)",
        "Ego-alter\n(alternate)"
      ))
    ),
    sampling=case_when(
      sampling == 'deg' ~ 'Prop. to\ndegree',
      sampling == 'edge' ~ 'Edge',
      sampling == 'node' ~ 'Node',
    ),
    sampling=factor(
      sampling,
      levels=c(
        'Edge',
        'Node',
        'Prop. to\ndegree'
      )
    )
  )

df_big = df_all %>%
  pivot_longer(
    cols=Y_no_model:Y_hat_egoalter_full,
    names_to='model',
    values_to='model_val'
  ) %>%
  mutate(
    mae=abs(model_val - Y_true) / Y_true,
    bias=(model_val - Y_true) / Y_true,
  )

df_p = df_perf %>%
  pivot_longer(
    cols=auc:accuracy,
    names_to='metric',
    values_to='val'
  ) %>%
  mutate(
    model=case_when(
      model == "node_nonetwork" ~ "Node\n(no network)",
      model == "node_basic" ~ "Node",
      model == "node_full" ~ "Node\n(more controls)",
      model == "egoalter_basic" ~ "Ego-alter",
      model == "egoalter_full" ~ "Ego-alter\n(more controls)",
    ),
    model=factor(
      model,
      levels=rev(c(
        'No model',
        "Edge",
        "Edge\n(no network)",
        "Edge\n(more controls)",
        "Node",
        "Node\n(no network)",
        "Node\n(more controls)",
        "Ego-alter",
        "Ego-alter\n(more controls)",
        "Ego-alter\n(alternate)"
      ))
    ),
    sampling=case_when(
      sampling == 'deg' ~ 'Prop. to\ndegree',
      sampling == 'edge' ~ 'Edge',
      sampling == 'node' ~ 'Node',
    ),
    sampling=factor(
      sampling,
      levels=c(
        'Edge',
        'Node',
        'Prop. to\ndegree'
      )
    )
  )  %>%
  group_by(model, sampling, metric) %>%
  summarize(
    std=sd(val) / sqrt(n()),
    val=mean(val)
  ) %>%
  inner_join(
    df %>%
      group_by(sampling, model) %>%
      summarize(mae=mean(mae), bias=mean(bias)),
    by=c('model', 'sampling')
  )
```

Main plot

```{r}
p1 = df %>%
  rename(Sampling=sampling) %>%
  filter(!(model %in% c(
    'No model',
    "Edge\n(more controls)",
    "Node\n(more controls)",
    "Edge\n(no network)"
  ))) %>% 
  group_by(model, Sampling) %>%
  summarize(std=sd(bias) / sqrt(n()), Bias=mean(bias)) %>%
  mutate(lcl = Bias - 1.96 * std, ucl = Bias + 1.96 * std) %>%
  ggplot(aes(x=model, y=Bias)) +
  geom_hline(
    yintercept = 0,
    linetype='dotdash',
    alpha=0.5
  ) +
  geom_pointrange(
    aes(ymin=lcl, ymax=ucl, shape=Sampling, color=model),
    position=position_dodge(width=0.5),
    size=0.45
  ) +
  guides(color=FALSE, shape=FALSE) +
  labs(
    x='Model',
    y='Bias (percent)',
    title='Bias'
  ) +
  lims(y=c(-0.1, 0.1)) +
  theme_cowplot() +
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=12),
    axis.title=element_text(size=13),
    plot.title = element_text(size=14)
  ) +
  scale_color_manual(values=palette) +
  coord_flip()
```

```{r}
p2 = df %>%
  rename(Sampling=sampling) %>%
  filter(!(model %in% c(
    'No model',
    "Edge\n(more controls)",
    "Node\n(more controls)",
    "Edge\n(no network)"
  ))) %>% 
  group_by(model, Sampling) %>%
  summarize(std=sd(mae) / sqrt(n()), mae=mean(mae)) %>%
  mutate(lcl = mae - 1.96 * std, ucl = mae + 1.96 * std) %>%
  ggplot(aes(x=model, y=mae)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_pointrange(
    aes(ymin=lcl, ymax=ucl, shape=Sampling, color=model),
    position=position_dodge(width=0.5),
    size=0.45
  ) +
  labs(
    x=element_blank(),
    y='Absolute error (percent)',
    title='Absolute error'
  ) +
  lims(y=c(0.0, 0.11)) +
  guides(color=FALSE,  shape = guide_legend(reverse=T)) +
  theme_cowplot() +
  theme(
    legend.position = c(0.7, 0.2),
    legend.box.background = element_rect(colour = "black"),
    legend.text=element_text(size=10),
    legend.title=element_text(size=11),
    axis.text.x=element_text(size=10),
    # axis.text.y=element_text(size=10),
    axis.title=element_text(size=13),
    axis.title.y=element_blank(),
    axis.text.y=element_blank(),
    plot.title = element_text(size=14)
  ) +
  scale_color_manual(values=palette) +
  coord_flip() 
```

```{r}
plot_grid(p1, p2, rel_widths = c(1.2, 1))
```
```{r}
ggsave(
  '/Users/georgeberry/Downloads/p1.pdf',
  plot_grid(p1, p2, rel_widths = c(1.4, 1)),
  device='pdf',
  width=7.04,
  height=3.5
)
```

perf plot

```{r}
p3 = df_p %>%
  filter(
    !(model %in% c(
      'Node\n(more controls)'
    )),
    metric == 'accuracy',
    sampling == 'Prop. to\ndegree'
  ) %>% 
  ggplot(aes(x=val, y=mae, color=model)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_jitter(size=3, width=0.000) +
  guides(color = FALSE) +
  lims(x=c(0.84, 0.89), y=c(-0.01, 0.1)) +
  labs(
    title='Abs. error by accuracy',
    x='Accuracy',
    y='Absolute error (percent)'
  ) +
  scale_color_manual(values=palette) +
  theme_cowplot() +
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=10),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=10),
    plot.title = element_text(size=13)
  )

p4 = df_p %>%
  filter(
    !(model %in% c(
      'Node\n(more controls)'
    )),
    metric == 'auc',
    sampling == 'Prop. to\ndegree'
  ) %>% 
  ggplot(aes(x=val, y=mae, color=model)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_jitter(size=3, width=0.000) +
  guides(color = FALSE) +
  lims(x=c(0.9, 0.95), y=c(-0.01, 0.1)) +
  labs(
    title='Abs. error by AUC',
    x='AUC',
    y='Absolute error (percent)'
  ) +
  scale_color_manual(values=palette) +
  theme_cowplot() +
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=10),
    axis.title.x=element_text(size=12),
    axis.title.y=element_text(size=10),
    plot.title = element_text(size=13)
  )

p5 = df_p %>%
  filter(
    !(model %in% c(
      'Node\n(more controls)'
    )),
    metric == 'accuracy',
    sampling == 'Prop. to\ndegree'
  ) %>% 
  ggplot(aes(x=val, y=bias, color=model)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_jitter(size=3, width=0.000) +
  guides(color = FALSE) +
  lims(x=c(0.84, 0.89), y=c(-0.1, 0.01)) +
  labs(
    title='Bias by Accuracy',
    x='Accuracy',
    y='Bias (percent)'
  ) +
  scale_color_manual(values=palette) +
  theme_cowplot() +
  theme(
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=10),
    axis.title=element_text(size=12),
    plot.title = element_text(size=13)
  )

p6 = df_p %>%
  filter(
    !(model %in% c(
      'Node\n(more controls)'
    )),
    metric == 'auc',
    sampling == 'Prop. to\ndegree'
  ) %>% 
  rename(Model=model) %>%
  ggplot(aes(x=val, y=bias, color=Model)) +
  geom_hline(yintercept = 0, linetype='dotdash', alpha=0.5) +
  geom_jitter(size=3, width=0.000) +
  guides(color = guide_legend(reverse=T)) +
  lims(x=c(0.9, 0.95), y=c(-0.1, 0.01)) +
  labs(
    title='Bias by AUC',
    x='AUC',
    y='Bias (percent)'
  ) +
  scale_color_manual(values=palette) +
  theme_cowplot() +
  theme(
    legend.position = c(0.65, 0.4),
    legend.box.background = element_rect(colour = "black"),
    legend.text=element_text(size=8),
    legend.title=element_text(size=9),
    axis.text.x=element_text(size=10),
    axis.text.y=element_text(size=10),
    axis.title=element_text(size=12),
    plot.title = element_text(size=13)
    #axis.title.y=element_blank(),
    #axis.text.y=element_blank(),
    #plot.title = element_text(size=14)
  )
```


```{r}
plot_grid(
  p3, p4, p5, p6,
  nrow=2, ncol=2,
  labels=c('A', 'B', 'C', 'D')  
)
```

```{r}
ggsave(
  '/Users/georgeberry/Downloads/p2.pdf',
  plot_grid(p3, p4, p5, p6, nrow=2, ncol=2, labels=c('A', 'B', 'C', 'D')),
  device='pdf',
  width=8,
  height=4.7
)
```


error as homophily varies
 
```{r}
df_big %>%
  group_by(
    sampling,
    model,
    kind 
  ) %>%
  summarize(
    mae=mean(mae),
    bias=mean(bias)
  ) %>%
  ggplot(aes(x=kind, y=bias, color=model, shape=sampling)) +
  geom_point()
```

```{r}

```




## All sims(appendix)


```{r}
p5 = df_bias %>%
  filter(model != "Ego-alter\n(downsampled)") %>%
  mutate(
    val=ifelse(abs(val) > 0.4, sign(val) * 0.4, val)
  ) %>%
  group_by(sim, level, model) %>%
  summarize(
    std=sd(val),
    val=mean(val)
  ) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level=='edge' ~ 'Edge sample',
      level=='node' ~ 'Node sample'
    )
  ) %>%
  rename(
    Simulation=sim
  ) %>%
  ggplot(aes(x=model, y=val, color=Simulation)) +
  geom_hline(yintercept=0, alpha=0.5, linetype='dotdash') +
  #geom_boxplot() +
  geom_point(position=position_dodge(width=0.6)) +
  geom_errorbar(
    aes(ymin=val - std, ymax = val + std),
    position=position_dodge(width=0.6),
    width=0.0
  ) +
  guides(colour = guide_legend(reverse=T)) +
  scale_color_manual(values=palette) +
  labs(
    x='Model',
    y='Bias (percent)',
    title='Comparison of all models across five simulations') + 
  theme_cowplot() +
  theme(
    legend.position="top",
    axis.text=element_text(size=10)
  ) +
  coord_flip() +
  panel_border() +
  facet_wrap(~level)

p6 = df_mae %>%
  filter(model != "Ego-alter\n(downsampled)") %>%
  mutate(
    val=ifelse(abs(val) > 0.4, sign(val) * 0.4, val)
  ) %>%
  #group_by(sim, level, model) %>%
  #summarize(
  #  std=sd(val),
  #  val=mean(val)
  #) %>%
  #ungroup() %>%
  mutate(
    level=case_when(
      level=='edge' ~ 'Edge sample',
      level=='node' ~ 'Node sample'
    )
  ) %>%
  rename(
    Simulation=sim
  ) %>%
  ggplot(aes(x=model, y=val, color=Simulation)) +
  geom_hline(yintercept=0, alpha=0.5, linetype='dotdash') +
  #geom_violin() +
  geom_boxplot() +
  #geom_point(position=position_dodge(width=0.6)) +
  #geom_errorbar(
  #  aes(ymin=val - std, ymax = val + std),
  #  position=position_dodge(width=0.6),
  #  width=0.0
  #) +
  guides(colour = guide_legend(reverse=T)) +
  scale_color_manual(values=palette) +
  labs(x='Model', y='Mean absolute error (percent)') + 
  theme_cowplot() +
  coord_flip() +
  theme(
    legend.position = 'none',
    axis.text=element_text(size=10)
  ) +
  panel_border() +
  facet_wrap(~level)
```



```{r}
plot_grid(p5, p6, ncol=1, rel_heights=c(1.15,1), labels=c('A', 'B'))
```

#### MAKE A TABLE FOR THE CURIOUS

sim/level on the y axis, model on the x axis

```{r}
df_table_mae = df_mae %>%
  group_by(sim, level, model) %>% 
  summarize(std=sd(val) / sqrt(n()), mu=mean(val)) %>%
  #pivot_longer(std:mu, names_to='metric', values_to='val') %>%
  #pivot_wider(names_from=model, values_from='val') %>%
  pivot_longer(mu, names_to='metric', values_to='val') %>%
  pivot_wider(id_cols=sim:level, names_from=model, values_from='val') %>%
  arrange(level, sim) %>%
  select(level, sim, everything()) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level == 'edge' ~ 'Edge',
      level == 'node' ~ 'Node'
    )
  ) %>%
  rename(
    Sim=sim,
    `\thead{Sampling level}`=level,
    `\thead{Node (no network)}`=`Node\n(no network)`,
    `\thead{Ego-alter (augmented)}`=`Ego-alter\n(augmented)`
  )

print(
  xtable(
    df_table_mae,
    digits=3,
    caption='Mean absolute error by simulation'
  ),
  include.rownames=FALSE
)
```



```{r}
df_table_bias = df_bias %>%
  group_by(sim, level, model) %>% 
  summarize(std=sd(val) / sqrt(n()), mu=mean(val)) %>%
  #pivot_longer(std:mu, names_to='metric', values_to='val') %>%
  #pivot_wider(names_from=model, values_from='val') %>%
  pivot_longer(mu, names_to='metric', values_to='val') %>%
  pivot_wider(id_cols=sim:level, names_from=model, values_from='val') %>%
  arrange(level, sim) %>%
  select(level, sim, everything()) %>%
  ungroup() %>%
  mutate(
    level=case_when(
      level == 'edge' ~ 'Edge',
      level == 'node' ~ 'Node'
    )
  ) %>%
  rename(
    Sim=sim,
    `\thead{Sampling level}`=level,
    `\thead{Node (no network)}`=`Node\n(no network)`,
    `\thead{Ego-alter (augmented)}`=`Ego-alter\n(augmented)`
  )

print(
  xtable(
    df_table_bias,
    digits=3,
    caption='Bias by simulation'
  ),
  include.rownames=FALSE
)
```